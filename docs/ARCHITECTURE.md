# ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Telegram Bot + Mini App Ğ´Ğ»Ñ Ñ„Ğ¸Ñ‚Ğ½ĞµÑ-ĞºĞ»ÑƒĞ±Ğ°

## 1. ĞĞ±Ğ·Ğ¾Ñ€ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              TELEGRAM                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Telegram Bot  â”‚                    â”‚     Telegram Mini App (WebApp)   â”‚ â”‚
â”‚  â”‚   - /start      â”‚  â”€â”€ĞºĞ½Ğ¾Ğ¿ĞºĞ°â”€â”€â–¶       â”‚     - Ğ ÑƒĞ»ĞµÑ‚ĞºĞ°                    â”‚ â”‚
â”‚  â”‚   - request_    â”‚  "ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ          â”‚     - initData â†’ Backend         â”‚ â”‚
â”‚  â”‚     contact     â”‚   Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ"      â”‚     - ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°     â”‚ â”‚
â”‚  â”‚   - Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ â”‚                    â”‚                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                              â”‚
            â”‚ Long Polling / Webhook                       â”‚ HTTPS
            â–¼                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         BACKEND (Go)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Bot Handler â”‚  â”‚  HTTP API    â”‚  â”‚ initData     â”‚  â”‚  Roulette        â”‚ â”‚
â”‚  â”‚  - /start    â”‚  â”‚  (Gin/Fiber) â”‚  â”‚ Validator   â”‚  â”‚  Service         â”‚ â”‚
â”‚  â”‚  - contact   â”‚  â”‚  - /api/*    â”‚  â”‚ (HMAC-SHA256)â”‚  â”‚  - spin (lock)   â”‚ â”‚
â”‚  â”‚  - webhooks  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚  - prizes        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                 â”‚                                       â”‚         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                           â”‚                                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                    â”‚  PostgreSQL â”‚   â”‚    Redis     â”‚                        â”‚
â”‚                    â”‚  (users,    â”‚   â”‚  (locks,     â”‚                        â”‚
â”‚                    â”‚   spins,    â”‚   â”‚   rate-limit)â”‚                        â”‚
â”‚                    â”‚   prizes)   â”‚   â”‚              â”‚                        â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. User Flow (Ğ¾Ñ‚ /start Ğ´Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° Ñ€ÑƒĞ»ĞµÑ‚ĞºĞ¸)

| Ğ¨Ğ°Ğ³ | Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ | Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° | Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ |
|-----|----------|---------|-----------|
| 1 | ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ `/start` | Bot | Ğ‘Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚: ĞµÑÑ‚ÑŒ Ğ»Ğ¸ phone Ğ² Ğ‘Ğ”? |
| 2a | Ğ•ÑĞ»Ğ¸ phone ĞĞ•Ğ¢ | Bot | Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ + ReplyKeyboard Ñ `request_contact` (Â«ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ¼Â») |
| 2b | Ğ•ÑĞ»Ğ¸ phone Ğ•Ğ¡Ğ¢Ğ¬ | Bot | Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ + InlineKeyboard Â«ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµÂ» (WebApp URL) |
| 3 | ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ Â«ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ¼Â» | Telegram | Telegram Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‘Ñ‚ contact (phone_number) Ğ² update |
| 4 | Bot Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ contact | Backend | Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ user + phone Ğ² PostgreSQL, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ + ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Â«ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµÂ» |
| 5 | ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ Â«ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµÂ» | Telegram | ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Mini App Ñ `tg.initData` |
| 6 | Mini App Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ÑÑ | Frontend | ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ POST /api/auth Ñ initData |
| 7 | Backend Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ initData | Backend | HMAC-SHA256 Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°, Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ user_id |
| 8 | initData Ğ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½ | Backend | ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ phone Ğ² Ğ‘Ğ” Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ user_id, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ user + Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ñ€ÑƒĞ»ĞµÑ‚ĞºĞµ |
| 9 | initData Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½ | Backend | 401 Unauthorized |
| 10 | ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ĞºÑ€ÑƒÑ‚Ğ¸Ñ‚ Ñ€ÑƒĞ»ĞµÑ‚ĞºÑƒ | Mini App | POST /api/roulette/spin (Ñ initData Ğ¸Ğ»Ğ¸ Bearer) |
| 11 | Backend Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ spin | Backend | Lock Ğ¿Ğ¾ user_id, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ¾Ğ², Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ¿Ñ€Ğ¸Ğ·Ğ°, ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Ğ‘Ğ”, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° |
| 12 | Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ | Backend | ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ Ğ² Telegram |
| 13 | ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ | Mini App | ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ· Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ |

---

## 3. Backend API (ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹)

### 3.1 ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¸ ÑĞµÑÑĞ¸Ñ

| ĞœĞµÑ‚Ğ¾Ğ´ | Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|-------|----------|------------|
| POST | `/api/auth` | Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ initData, Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ° JWT/ÑĞµÑÑĞ¸Ğ¸. Body: `{ "initData": "..." }`. Response: `{ "user": {...}, "token": "..." }` |
| POST | `/api/auth/refresh` | ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾) |

### 3.2 ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ

| ĞœĞµÑ‚Ğ¾Ğ´ | Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|-------|----------|------------|
| GET | `/api/user/me` | Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ (Ğ¿Ğ¾ JWT / initData). Response: user, phone, spin_available |
| GET | `/api/user/state` | Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Mini App (Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ»Ğ¸ ĞºÑ€ÑƒÑ‚Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾ ÑƒĞ¶Ğµ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ğ°Ğ») |

### 3.3 Ğ ÑƒĞ»ĞµÑ‚ĞºĞ°

| ĞœĞµÑ‚Ğ¾Ğ´ | Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|-------|----------|------------|
| POST | `/api/roulette/spin` | ĞšÑ€ÑƒÑ‚Ğ¸Ñ‚ÑŒ Ñ€ÑƒĞ»ĞµÑ‚ĞºÑƒ. Lock, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ¾Ğ², Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ¿Ñ€Ğ¸Ğ·Ğ°, ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ, ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ |
| GET | `/api/roulette/config` | ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ Ñ€ÑƒĞ»ĞµÑ‚ĞºĞ¸ (ÑĞµĞ³Ğ¼ĞµĞ½Ñ‚Ñ‹, Ğ²ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚Ğ¸ â€” Ğ±ĞµĞ· ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ²) |
| GET | `/api/roulette/history` | Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ¿Ğ¸Ğ½Ğ¾Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ |

### 3.4 Webhook Ğ´Ğ»Ñ Ğ±Ğ¾Ñ‚Ğ° (Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹)

| ĞœĞµÑ‚Ğ¾Ğ´ | Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|-------|----------|------------|
| POST | `/webhook/telegram` | ĞŸÑ€Ğ¸Ñ‘Ğ¼ updates Ğ¾Ñ‚ Telegram (ĞµÑĞ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ webhook) |

---

## 4. Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ‘Ğ” (PostgreSQL)

### 4.1 users

| ĞŸĞ¾Ğ»Ğµ | Ğ¢Ğ¸Ğ¿ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------|-----|----------|
| id | BIGSERIAL PK | Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ ID |
| telegram_user_id | BIGINT UNIQUE NOT NULL | Telegram user id |
| phone | VARCHAR(20) UNIQUE NOT NULL | ĞĞ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° (E.164) |
| first_name | VARCHAR(100) | Ğ˜Ğ¼Ñ Ğ¸Ğ· Telegram |
| last_name | VARCHAR(100) | Ğ¤Ğ°Ğ¼Ğ¸Ğ»Ğ¸Ñ |
| username | VARCHAR(100) | @username |
| created_at | TIMESTAMPTZ | |
| updated_at | TIMESTAMPTZ | |

**Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹:** `telegram_user_id`, `phone`, `created_at`

### 4.2 prizes (ÑĞ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¿Ñ€Ğ¸Ğ·Ğ¾Ğ²)

| ĞŸĞ¾Ğ»Ğµ | Ğ¢Ğ¸Ğ¿ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------|-----|----------|
| id | SERIAL PK | |
| name | VARCHAR(100) | ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ·Ğ° |
| type | VARCHAR(20) | discount, bonus, free_month, merch |
| value | DECIMAL(10,2) | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ (%, ÑÑƒĞ¼Ğ¼Ğ° Ğ¸ Ñ‚.Ğ´.) |
| probability_weight | INT | Ğ’ĞµÑ Ğ´Ğ»Ñ Ñ€ÑƒĞ»ĞµÑ‚ĞºĞ¸ (Ñ‡ĞµĞ¼ Ğ²Ñ‹ÑˆĞµ â€” Ñ‡Ğ°Ñ‰Ğµ) |
| is_active | BOOLEAN | |
| created_at | TIMESTAMPTZ | |

### 4.3 spins (Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ¿Ğ¸Ğ½Ğ¾Ğ²)

| ĞŸĞ¾Ğ»Ğµ | Ğ¢Ğ¸Ğ¿ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------|-----|----------|
| id | BIGSERIAL PK | |
| user_id | BIGINT FK â†’ users.id | |
| prize_id | INT FK â†’ prizes.id | |
| result_value | DECIMAL(10,2) | Ğ’Ñ‹Ğ¿Ğ°Ğ²ÑˆĞµĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
| ip_hash | VARCHAR(64) | Ğ¥ĞµÑˆ IP Ğ´Ğ»Ñ Ğ°Ğ½Ñ‚Ğ¸Ñ„Ñ€Ğ¾Ğ´Ğ° (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾) |
| created_at | TIMESTAMPTZ | |

**Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹:** `user_id`, `created_at`, `(user_id, created_at)` Ğ´Ğ»Ñ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ¾Ğ²

### 4.4 admin_notifications (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾, Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ² ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹)

| ĞŸĞ¾Ğ»Ğµ | Ğ¢Ğ¸Ğ¿ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------|-----|----------|
| id | BIGSERIAL PK | |
| spin_id | BIGINT FK â†’ spins.id | |
| admin_telegram_id | BIGINT | ĞšĞ¾Ğ¼Ñƒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ |
| sent_at | TIMESTAMPTZ | |

---

## 5. Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ¸ Ğ°Ğ½Ñ‚Ğ¸Ñ„Ñ€Ğ¾Ğ´Ğ°

### 5.1 Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ initData (Telegram WebApp)

```
1. ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ query string Ğ¸Ğ· initData
2. Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ°Ñ€ key=value Ğ¿Ğ¾ ĞºĞ»ÑÑ‡Ñƒ
3. data_check_string = key1=value1\nkey2=value2\n...
4. secret_key = HMAC-SHA256("WebAppData", BOT_TOKEN)
5. hash = HMAC-SHA256(data_check_string, secret_key)
6. Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ÑŒ hash Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ hash (hex)
7. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ auth_date â€” Ğ½Ğµ ÑÑ‚Ğ°Ñ€ÑˆĞµ 24 Ñ‡Ğ°ÑĞ¾Ğ²
8. Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ user Ğ¸Ğ· JSON
```

### 5.2 ĞĞ´Ğ¸Ğ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ â€” Ğ¾Ğ´Ğ¸Ğ½ Ğ½Ğ¾Ğ¼ĞµÑ€

- `users.phone` UNIQUE
- ĞŸÑ€Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ contact: Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ¹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¿Ğ¾ `telegram_user_id`
- Ğ•ÑĞ»Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ user Ğ¿Ñ‹Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ phone â€” Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ÑÑ‚ÑŒ Ğ¸Ğ»Ğ¸ ÑĞ²ÑĞ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ (Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ)

### 5.3 Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ñ… ÑĞ¿Ğ¸Ğ½Ğ¾Ğ²

- **Redis lock** Ğ½Ğ° `roulette:spin:{user_id}` Ñ TTL 5â€“10 ÑĞµĞº
- **PostgreSQL Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ** Ğ¿Ñ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸ spin Ñ SELECT FOR UPDATE Ğ¿Ğ¾ user_id
- **ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ¾Ğ²:** Ğ¾Ğ´Ğ¸Ğ½ ÑĞ¿Ğ¸Ğ½ Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ·Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ (Ğ´ĞµĞ½ÑŒ / Ğ½ĞµĞ´ĞµĞ»Ñ / Ğ²ÑĞµĞ³Ğ¾) â€” Ğ¿Ğ¾ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ spins
- **Idempotency:** optional header `X-Idempotency-Key` Ğ´Ğ»Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹ Ğ¾Ñ‚ Ğ´Ğ²Ğ¾Ğ¹Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²

### 5.4 Rate limiting

- Redis: N Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ½Ğ° IP / user_id Ğ² Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ
- Endpoint `/api/roulette/spin`: ÑÑ‚Ñ€Ğ¾Ğ³Ğ¸Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ (1â€“2 req/min Ğ½Ğ° user)

### 5.5 ĞĞ½Ñ‚Ğ¸Ñ„Ñ€Ğ¾Ğ´

- Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ IP (Ñ…ĞµÑˆ), User-Agent
- Ğ”ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¹: Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ² Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ IP
- ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ: Ğ¾Ğ´Ğ¸Ğ½ phone = Ğ¾Ğ´Ğ¸Ğ½ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Telegram

---

## 6. Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ

ĞŸĞ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ spin:

```
Bot.sendMessage(
  admin_telegram_chat_id,
  fmt.Sprintf("ğŸ° ĞĞ¾Ğ²Ñ‹Ğ¹ ÑĞ¿Ğ¸Ğ½!\nĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: %s %s (@%s)\nĞ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½: %s\nĞŸÑ€Ğ¸Ğ·: %s\nĞ’Ñ€ĞµĞ¼Ñ: %s",
    user.FirstName, user.LastName, user.Username, user.Phone, prize.Name, time.Now()),
)
```

ĞĞ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ğ¹ chat_id Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğµ/ENV.

---

## 7. Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Go-Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

```
era_sporta_bot_ruletka/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ bot/           # Ğ—Ğ°Ğ¿ÑƒÑĞº Telegram-Ğ±Ğ¾Ñ‚Ğ°
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â””â”€â”€ api/           # Ğ—Ğ°Ğ¿ÑƒÑĞº HTTP API
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ bot/
â”‚   â”‚   â”œâ”€â”€ handler.go       # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ /start, contact
â”‚   â”‚   â”œâ”€â”€ keyboard.go      # ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹ (request_contact, WebApp URL)
â”‚   â”‚   â””â”€â”€ notify.go        # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ router.go        # ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Gin/Fiber
â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.go      # Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ initData / JWT
â”‚   â”‚   â”‚   â”œâ”€â”€ ratelimit.go # Rate limiting
â”‚   â”‚   â”‚   â””â”€â”€ recovery.go  # Panic recovery
â”‚   â”‚   â””â”€â”€ handlers/
â”‚   â”‚       â”œâ”€â”€ auth.go      # POST /api/auth
â”‚   â”‚       â”œâ”€â”€ user.go      # GET /api/user/me, /api/user/state
â”‚   â”‚       â””â”€â”€ roulette.go  # POST /api/roulette/spin
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”œâ”€â”€ user.go          # User entity, repository interface
â”‚   â”‚   â”œâ”€â”€ spin.go          # Spin, Prize
â”‚   â”‚   â””â”€â”€ roulette.go      # Roulette logic interface
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ user.go          # UserService
â”‚   â”‚   â”œâ”€â”€ roulette.go      # RouletteService (spin logic, lock, DB)
â”‚   â”‚   â””â”€â”€ telegram.go      # InitData validation, helper
â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”œâ”€â”€ user.go          # PostgreSQL
â”‚   â”‚   â”œâ”€â”€ spin.go
â”‚   â”‚   â””â”€â”€ prize.go
â”‚   â”œâ”€â”€ telegram/
â”‚   â”‚   â”œâ”€â”€ initdata.go      # ValidateInitData(data, botToken string)
â”‚   â”‚   â””â”€â”€ client.go        # Bot API client
â”‚   â””â”€â”€ storage/
â”‚       â””â”€â”€ redis.go         # Lock, rate-limit (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
â”œâ”€â”€ migrations/              # SQL Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ (golang-migrate, goose)
â”‚   â”œâ”€â”€ 001_create_users.sql
â”‚   â”œâ”€â”€ 002_create_prizes.sql
â”‚   â””â”€â”€ 003_create_spins.sql
â”œâ”€â”€ web/                     # Mini App frontend (ĞµÑĞ»Ğ¸ Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ñ€ĞµĞ¿Ğ¾)
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ app.js
â”‚   â””â”€â”€ ...
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.go
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ .env.example
â””â”€â”€ README.md
```

---

## 8. Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Go

```go
// go.mod
require (
    github.com/gin-gonic/gin v1.9.1        // Ğ¸Ğ»Ğ¸ github.com/gofiber/fiber/v2
    github.com/jackc/pgx/v5 v5.5.0
    github.com/redis/go-redis/v9 v9.3.0
    github.com/go-telegram-bot-api/telegram-bot-api/v5 v5.5.1  // Ğ¸Ğ»Ğ¸ github.com/mymmrac/telego
)
```

---

## 9. ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ (.env.example)

```env
# Bot
BOT_TOKEN=your_bot_token_here
ADMIN_TELEGRAM_CHAT_ID=123456789
WEBAPP_URL=https://your-domain.com/webapp

# API
API_PORT=8080
API_SECRET_KEY=your_secret_for_jwt_if_used

# Database
DATABASE_URL=postgres://user:pass@localhost:5432/era_sporta?sslmode=disable

# Redis (optional)
REDIS_URL=redis://localhost:6379/0

# Roulette
ROULETTE_SPIN_LIMIT_PER_USER=1
ROULETTE_LOCK_TTL_SEC=10
```

---

## 10. Checklist Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

- [ ] ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ‘Ğ”
- [ ] Bot: /start, request_contact, ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ phone
- [ ] Bot: ĞºĞ½Ğ¾Ğ¿ĞºĞ° Â«ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµÂ» Ñ WebApp URL
- [ ] API: Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ initData
- [ ] API: GET /api/user/me, /api/user/state
- [ ] API: POST /api/roulette/spin Ñ lock Ğ¸ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸ĞµĞ¹
- [ ] Ğ¡ĞµÑ€Ğ²Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ
- [ ] Mini App frontend (Ñ€ÑƒĞ»ĞµÑ‚ĞºĞ°, Ğ²Ñ‹Ğ·Ğ¾Ğ² API)
- [ ] Rate limiting Ğ¸ Ğ°Ğ½Ñ‚Ğ¸Ñ„Ñ€Ğ¾Ğ´
- [ ] Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹, SSL Ğ´Ğ»Ñ WebApp
