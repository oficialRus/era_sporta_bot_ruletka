# Era Sporta Bot - Telegram –†—É–ª–µ—Ç–∫–∞

Telegram –±–æ—Ç —Å —Ä—É–ª–µ—Ç–∫–æ–π –¥–ª—è —Ñ–∏—Ç–Ω–µ—Å-–∫–ª—É–±–∞ "–≠—Ä–∞ –°–ø–æ—Ä—Ç–∞".

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
go mod download
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–§–∞–π–ª `.env` —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏:
- Telegram Bot Token
- Admin Chat ID
- Channel ID –∏ URL
- Web App URL
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
go run ./cmd/initdb
```

–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞:
- –°–æ–∑–¥–∞—Å—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö `era_sporta` (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- –ü—Ä–∏–º–µ–Ω–∏—Ç –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- –°–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—ã: users, prizes, spins
- –î–æ–±–∞–≤–∏—Ç –ø—Ä–∏–∑—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### 4. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤

#### –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏:

**–¢–µ—Ä–º–∏–Ω–∞–ª 1 - API —Å–µ—Ä–≤–µ—Ä:**
```bash
go run ./cmd/api
# –ó–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ :8080
```

**–¢–µ—Ä–º–∏–Ω–∞–ª 2 - Telegram –±–æ—Ç:**
```bash
go run ./cmd/bot
```

**–¢–µ—Ä–º–∏–Ω–∞–ª 3 - Web —Å–µ—Ä–≤–µ—Ä (–¥–ª—è Mini App):**
```bash
go run ./cmd/serveweb
```

#### –ò–ª–∏ —Å–æ–±–µ—Ä–∏—Ç–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–∏:

```bash
mkdir -p bin
go build -o bin/api ./cmd/api
go build -o bin/bot ./cmd/bot
go build -o bin/serveweb ./cmd/serveweb

# –ó–∞–ø—É—Å–∫
./bin/api &
./bin/bot &
./bin/serveweb &
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îú‚îÄ‚îÄ api/         # HTTP API —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ bot/         # Telegram –±–æ—Ç
‚îÇ   ‚îú‚îÄ‚îÄ serveweb/    # –í–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è Mini App
‚îÇ   ‚îî‚îÄ‚îÄ initdb/      # –£—Ç–∏–ª–∏—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î
‚îú‚îÄ‚îÄ config/          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ bot/         # –õ–æ–≥–∏–∫–∞ –±–æ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ db/          # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ repository/  # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ service/     # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ migrations/      # SQL –º–∏–≥—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ scripts/         # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
‚îú‚îÄ‚îÄ web/             # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã Mini App
‚îú‚îÄ‚îÄ .env             # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–µ –≤ git)
‚îî‚îÄ‚îÄ .env.example     # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**–¢–∞–±–ª–∏—Ü—ã:**
- `users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (telegram_user_id, phone, –∏–º–µ–Ω–∞)
- `prizes` - –ø—Ä–∏–∑—ã (–Ω–∞–∑–≤–∞–Ω–∏–µ, —Ç–∏–ø, –∑–Ω–∞—á–µ–Ω–∏–µ, –≤–µ—Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏)
- `spins` - –∏—Å—Ç–æ—Ä–∏—è –≤—Ä–∞—â–µ–Ω–∏–π —Ä—É–ª–µ—Ç–∫–∏

**–ü—Ä–∏–∑—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:**
- –°–∫–∏–¥–∫–∞ 5% (–≤–µ—Å: 50)
- –°–∫–∏–¥–∫–∞ 10% (–≤–µ—Å: 30)
- –°–∫–∏–¥–∫–∞ 20% (–≤–µ—Å: 15)
- 1 –º–µ—Å—è—Ü –±–µ—Å–ø–ª–∞—Ç–Ω–æ (–≤–µ—Å: 5)

## üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö (—Ç–∞–±–ª–∏—Ü—ã –æ—Å—Ç–∞—é—Ç—Å—è):
```bash
PGPASSWORD=change_me psql -U app -h localhost -d era_sporta -f scripts/reset_db.sql
```

### –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ë–î –ø–æ–ª–Ω–æ—Å—Ç—å—é:
```bash
PGPASSWORD=change_me psql -U app -h localhost -d postgres -c "DROP DATABASE IF EXISTS era_sporta"
go run ./cmd/initdb
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ë–î:
```bash
PGPASSWORD=change_me psql -U app -h localhost -d era_sporta -c "\dt"
PGPASSWORD=change_me psql -U app -h localhost -d era_sporta -c "SELECT * FROM prizes"
```

## üìù –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ `.env`:

```env
# Telegram
BOT_TOKEN=...                    # –¢–æ–∫–µ–Ω –±–æ—Ç–∞
ADMIN_TELEGRAM_CHAT_ID=...       # ID –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ —á–∞—Ç–∞
TELEGRAM_CHANNEL_ID=...          # ID –∫–∞–Ω–∞–ª–∞
TELEGRAM_CHANNEL_URL=...         # URL –∫–∞–Ω–∞–ª–∞

# Web App
WEBAPP_URL=...                   # URL Mini App

# API
API_PORT=8080                    # –ü–æ—Ä—Ç API —Å–µ—Ä–≤–µ—Ä–∞

# Database
DATABASE_URL=...                 # PostgreSQL connection string

# Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
REDIS_URL=...                    # Redis connection string

# Roulette
ROULETTE_SPIN_LIMIT_PER_USER=1   # –õ–∏–º–∏—Ç –≤—Ä–∞—â–µ–Ω–∏–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
ROULETTE_LOCK_TTL_SEC=10         # –í—Ä–µ–º—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤—Ä–∞—â–µ–Ω–∏—è (—Å–µ–∫)
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –≤ `docs/ARCHITECTURE.md`

### User Flow:
1. `/start` ‚Üí –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç phone
2. –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç contact
3. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
4. Mini App ‚Üí –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç initData ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä—É–ª–µ—Ç–∫—É
5. Spin ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ ‚Üí —Ä–∞—Å—á–µ—Ç –ø—Ä–∏–∑–∞ ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- initData –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ HMAC-SHA256
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª
- –õ–∏–º–∏—Ç—ã –Ω–∞ –≤—Ä–∞—â–µ–Ω–∏—è (1 —Ä–∞–∑ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- Lock —á–µ—Ä–µ–∑ Redis –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–µ–π
- IP hash –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ö–∞–Ω–∞–ª: https://t.me/erasporta_apsheronsk
